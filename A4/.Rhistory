library(data.table)
library(tidyverse)
library(arrow)
library(arrow)
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
df <- fread('../../../datasets/NACC/csv/raw/investigator_ftldlbd_nacc65.csv')
subset <- df |> select(all_of(c('NACCID', 'NACCADC', 'VISITDAY', 'VISITMO', 'VISITYR', 'NACCACTV',
'DEMENTED', 'NACCADMD', 'NACCALZD', 'NACCALZP', 'PROBAD', 'PROBADIF',
'POSSAD', 'POSSADIF', 'NACCETPR',
'BIRTHMO', 'BIRTHYR', 'SEX', 'RACE', 'EDUC', 'NACCAGE', 'NACCAGEB', 'NACCNE4S',
'NACCTBI', 'TBI', 'TBIBRIEF', 'TBIWOLOS',
'TOBAC30', 'TOBAC100', 'SMOKYRS', 'PACKSPER', 'QUITSMOK',
'ALCFREQ', 'ALCOHOL', 'ALCABUSE',
'HYPERT', 'HYPERTEN', 'HXHYPER', 'NACCAHTN', 'NACCHTNC',
'NACCBMI',
'NACCDBMD', 'DIABET', 'DIABETES',
'HEARING', 'HEARAID', 'HEARWAID',
'DEPD', 'DEPDSEV', 'NACCGDS', 'NACCADEP', 'DEPTREAT', 'DEP2YRS', 'DEPOTHR'
)))
colnames(subset)
length(unique(subset$NACCID)) # 50962 people
length(unique(subset[subset$DEMENTED == 1, ]$NACCID)) # 21612 with dementia
length(unique(subset$NACCID)) - length(unique(subset[subset$DEMENTED == 1, ]$NACCID)) # 29350 non-dementia
hist(subset$NACCAGEB)
table(subset$DEMENTED)
table(subset$NACCADMD)
table(subset$NACCALZD)
# export demo/lancet data
write_parquet(subset, '../tidy_data/demo_lancet.parquet')
subset <- df |> select(all_of(c('NACCID', 'NACCADC', 'VISITDAY', 'VISITMO', 'VISITYR', 'NACCACTV',
'DEMENTED', 'NACCADMD', 'NACCALZD', 'NACCALZP', 'PROBAD', 'PROBADIF',
'POSSAD', 'POSSADIF', 'NACCETPR',
'BIRTHMO', 'BIRTHYR', 'SEX', 'RACE', 'EDUC', 'NACCAGE', 'NACCAGEB', 'NACCNE4S', 'NACCUDSD',
'NACCTBI', 'TBI', 'TBIBRIEF', 'TBIWOLOS',
'TOBAC30', 'TOBAC100', 'SMOKYRS', 'PACKSPER', 'QUITSMOK',
'ALCFREQ', 'ALCOHOL', 'ALCABUSE',
'HYPERT', 'HYPERTEN', 'HXHYPER', 'NACCAHTN', 'NACCHTNC',
'NACCBMI',
'NACCDBMD', 'DIABET', 'DIABETES',
'HEARING', 'HEARAID', 'HEARWAID',
'DEPD', 'DEPDSEV', 'NACCGDS', 'NACCADEP', 'DEPTREAT', 'DEP2YRS', 'DEPOTHR'
)))
# export demo/lancet data
write_parquet(subset, '../tidy_data/demo_lancet.parquet')
library(arrow)
library(mice)
library(JMbayes2)
library(tidyverse)
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
# Read the parquet file
df <- read_parquet('../../tidy_data/A4/ptau_habits_phyneuro.parquet')
df <- df %>% select(c('BID', 'ORRES', 'COLLECTION_DATE_DAYS_CONSENT',
'time_to_event', 'label', 'AGEYR', 'SEX', 'EDCCNTU', 'APOEGN', 'RACE',
'PXCARD', # 'PXPULM',
'SMOKE', 'ALCOHOL', 'SUBUSE', 'AEROBIC', 'WALKING'
))
df$BID = as.integer(factor(df$BID))
df$APOEGN = factor(df$APOEGN)
df$PXCARD = factor(df$PXCARD)
# df$PXPULM = factor(df$PXPULM)
df$SUBUSE = factor(df$SUBUSE)
df$SEX = factor(df$SEX)
df$RACE = factor(df$RACE)
# df$label = factor(df$label)
# Check missingness pattern
md.pattern(df)
df_surv <- df %>%
group_by(BID) %>%
slice_max(order_by = label, n = 1, with_ties = FALSE) %>%
ungroup()
head(df_surv)
sum(df_surv$label)
df_lm <- df %>% select(c('BID', 'COLLECTION_DATE_DAYS_CONSENT', 'ORRES', 'AGEYR', 'SEX', 'EDCCNTU', 'APOEGN', 'RACE', 'PXCARD', 'SMOKE', 'ALCOHOL',
'SUBUSE', 'AEROBIC', 'WALKING'))
# Fit a linear mixed-effects model for A over time
lmeFit <- lme(ORRES ~ COLLECTION_DATE_DAYS_CONSENT + AGEYR + SEX + EDCCNTU + APOEGN + RACE + PXCARD + SMOKE + ALCOHOL + SUBUSE + AEROBIC + WALKING,
random = ~ COLLECTION_DATE_DAYS_CONSENT | BID, data = df_lm)
# Fit a linear mixed-effects model for A over time
lmeFit <- lme(ORRES ~ COLLECTION_DATE_DAYS_CONSENT + AGEYR + SEX + EDCCNTU + APOEGN,
random = ~ COLLECTION_DATE_DAYS_CONSENT | BID, data = df_lm)
sum(is.na(df$ORRES))
sum(is.na(df$COLLECTION_DATE_DAYS_CONSENT))
sum(is.na(df$AGEYR))
sum(is.na(df$SEX))
sum(is.na(df$EDCCNTU))
sum(is.na(df$APOEGN))
df[is.na(df$APOEGN),]
# Fit a linear mixed-effects model for A over time
lmeFit <- lme(ORRES ~ COLLECTION_DATE_DAYS_CONSENT + AGEYR + SEX + EDCCNTU,
random = ~ COLLECTION_DATE_DAYS_CONSENT | BID, data = df_lm)
sum(is.na(df$APOEGN))
sum(is.na(df$BID))
# Fit a linear mixed-effects model for A over time
lmeFit <- lme(ORRES ~ COLLECTION_DATE_DAYS_CONSENT + AGEYR + SEX + EDCCNTU,
random = ~ COLLECTION_DATE_DAYS_CONSENT | BID, data = df_lm, na.action=na.exclude)
# Fit a linear mixed-effects model for A over time
lmeFit <- lme(ORRES ~ COLLECTION_DATE_DAYS_CONSENT + AGEYR + SEX + EDCCNTU + APOEGN,
random = ~ COLLECTION_DATE_DAYS_CONSENT | BID, data = df_lm, na.action=na.exclude)
lmeFit
summary(lmeFit)
# Fit a linear mixed-effects model for A over time
lmeFit <- lme(ORRES ~ AGEYR + SEX + EDCCNTU + APOEGN,
random = ~ COLLECTION_DATE_DAYS_CONSENT | BID, data = df_lm, na.action=na.exclude)
summary(lmeFit)
# remove one patient who has a missing APOE genotype, which we do not want to impute
df[is.na(df$APOEGN),]
df <- df[df$BID != 1320,]
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
# Read the parquet file
df <- read_parquet('../../tidy_data/A4/ptau_habits_phyneuro.parquet')
df <- df %>% select(c('BID', 'ORRES', 'COLLECTION_DATE_DAYS_CONSENT',
'time_to_event', 'label', 'AGEYR', 'SEX', 'EDCCNTU', 'APOEGN', 'RACE',
'PXCARD', # 'PXPULM',
'SMOKE', 'ALCOHOL', 'SUBUSE', 'AEROBIC', 'WALKING'
))
# remove one patient who has a missing APOE genotype, which we do not want to impute
df[is.na(df$APOEGN),]
df <- df[df$BID != 1320,]
df$BID = as.integer(factor(df$BID))
df$APOEGN = factor(df$APOEGN)
df$PXCARD = factor(df$PXCARD)
# df$PXPULM = factor(df$PXPULM)
df$SUBUSE = factor(df$SUBUSE)
df$SEX = factor(df$SEX)
df$RACE = factor(df$RACE)
# df$label = factor(df$label)
df_surv <- df %>%
group_by(BID) %>%
slice_max(order_by = label, n = 1, with_ties = FALSE) %>%
ungroup()
df[df$label == 1,]
df[df$BID == 10,]
library(arrow)
library(mice)
library(JMbayes2)
library(tidyverse)
# NOTES
# GO TO THE END AFTER JOING MODEL FITS
# APOEGN consistently has terrible Rhats. Maybe remove the least common ones?
# Five-fold CV based on BID, stratified by label, can use df_surv variable for this
# For each fold:
# mice imputation - either do this before CV (not great), or just run it separately on train and test with same settings, method, predictor matrix
# Fit to train
# Use jointFit object to predict on test
# Find best threshold, calculate metrics, store
# Open question: do we include COLLECTION_DATE_DAYS_CONSENT, time_to_event, and label when imputing? I think so, because we are only doing it for
# set the working directory to where this script is located
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
# Read the parquet file
df <- read_parquet('../../tidy_data/A4/ptau_habits_phyneuro.parquet')
df <- df %>% select(c('BID', 'ORRES', 'COLLECTION_DATE_DAYS_CONSENT',
'time_to_event', 'label', 'AGEYR', 'SEX', 'EDCCNTU', 'APOEGN', 'RACE',
'PXCARD', # 'PXPULM',
'SMOKE', 'ALCOHOL', 'SUBUSE', 'AEROBIC', 'WALKING'
))
